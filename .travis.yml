language: python
sudo: false
python:
  - "2.7"
addons:
  apt:
    packages:
    - libev-dev
    - libsnappy-dev
    - zlib1g-dev  # for librdkafka
env:
  - TOXENV=py27 BROKERS=localhost:9092,localhost:9093,localhost:9094 ZOOKEEPER=localhost:2181 KAFKA_BIN=/home/travis/kafka-bin
  #- TOXENV=py34 BROKERS=localhost:9092,localhost:9093,localhost:9094 ZOOKEEPER=localhost:2181 KAFKA_BIN=/home/travis/kafka-bin
  #- TOXENV=pypy BROKERS=localhost:9092,localhost:9093,localhost:9094 ZOOKEEPER=localhost:2181 KAFKA_BIN=/home/travis/kafka-bin

install:
    - pip install codecov kazoo tox testinstances
    - wget https://github.com/edenhill/librdkafka/archive/0.8.6.tar.gz
    - tar -xzf 0.8.6.tar.gz
    - cd librdkafka-0.8.6/ && ./configure --prefix=$HOME
    - make && make install && cd -

before_script:
    - export C_INCLUDE_PATH=$HOME/include:$C_INCLUDE_PATH
    - export LIBRARY_PATH=$HOME/lib:$LIBRARY_PATH
    - export LD_LIBRARY_PATH=$HOME/lib:$LD_LIBRARY_PATH
    - export CFLAGS="-coverage"
    - "python -m pykafka.test.kafka_instance 3 --download-dir /home/travis/kafka-bin &"
    - "sleep 10"

script:
    - tox -- tests/pykafka/rdkafka/test_rd_kafka_consumer.py

after_success:
    # although codecov runs gcov, this tends to fail on travis-ci ("cannot
    # open graph file"), so we run it in advance with some custom flags, and
    # codecov will find the resulting output
    # gcov -b -c -o `find . -type f -name '*.gcno' -exec dirname {} \;` pykafka/rdkafka/_rd_kafkamodule.c
    - codecov --gcov-args "-b -c -o" --dump
    - codecov --gcov-args "-b -c -o $(find . -type f -name '*.gcno' -exec dirname {} \;)" --dump
    - gcov --version
